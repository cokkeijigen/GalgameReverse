cmake_minimum_required(VERSION 3.20.0)
project(amanomiko_patch)

set(CMAKE_CXX_STANDARD 20)

set(SOURCE_DIR "${CMAKE_CURRENT_LIST_DIR}/src")

if (MSVC)
	add_compile_options("/source-charset:utf-8")
	if(${CMAKE_BUILD_TYPE} STREQUAL "Release")
		set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded")
	elseif(${CMAKE_BUILD_TYPE} STREQUAL "Debug")
		set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreadedDebug")
	endif()

	# 安装 VC-LTL5（可选）
	# https://github.com/Chuyu-Team/VC-LTL5/releases/latest
	include("${CMAKE_CURRENT_LIST_DIR}/msvc/VC-LTL helper for cmake.cmake")

	set(YY_THUNKS_Win2K_OBJ "${CMAKE_CURRENT_LIST_DIR}/msvc/YY_Thunks_for_Win2K.obj.bin")
	set(CMAKE_CXX_STANDARD_LIBRARIES "\"${YY_THUNKS_Win2K_OBJ}\" ${CMAKE_CXX_STANDARD_LIBRARIES}")
    	set(CMAKE_C_STANDARD_LIBRARIES   "\"${YY_THUNKS_Win2K_OBJ}\" ${CMAKE_C_STANDARD_LIBRARIES}")
	set(YY_THUNKS_ENTRY "/ENTRY:DllMainCRTStartupForYY_Thunks")
    add_link_options("-SUBSYSTEM:CONSOLE,5.01")
endif(MSVC)

add_library(${PROJECT_NAME} SHARED
	"${SOURCE_DIR}/amanomiko_patch.c" 
	"${SOURCE_DIR}/amanomiko_patch.cpp" 
)

target_include_directories(${PROJECT_NAME} 
	PUBLIC "${SOURCE_DIR}/compat"
)

set_target_properties(${PROJECT_NAME} PROPERTIES
    LINK_FLAGS "${YY_THUNKS_ENTRY} /DYNAMICBASE:NO"
)

add_definitions("-DUSE_COMPAT")